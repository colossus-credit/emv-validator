# EMV Card Data Element Specification (with Merchant ID and Terminal ID)

This document defines the key EMV tags that an EMV card must support for transaction processing (especially CDA). It specifies encoding, length, order, and bounds.

---

## 1. General Encoding Rules
- All EMV fields use BER-TLV encoding (`Tag | Length | Value`).
- Multi-byte numeric values are big-endian.
- Amounts and dates use BCD (binary-coded decimal).
- Length field can be 1 or more bytes (short form if ≤127, long form otherwise).

---

## 2. Mandatory Application Data Elements

| Tag   | Name                                | Length | Format   | Notes |
|-------|-------------------------------------|--------|----------|-------|
| 9F26  | Application Cryptogram (ARQC/TC/AAC) | 8      | Binary   | Generated by card; unique per transaction |
| 9F27  | Cryptogram Information Data          | 1      | Binary   | 0x80 = ARQC, 0x40 = TC, 0x00 = AAC |
| 9F10  | Issuer Application Data (IAD)        | 8–32   | Binary   | Proprietary, opaque to terminal |
| 9F36  | Application Transaction Counter (ATC) | 2      | Binary   | Increments monotonically (0x0001–0xFFFF) |
| 9F37  | Unpredictable Number (UN)            | 4      | Binary   | From terminal, card must use it in ARQC calc |
| 95    | Terminal Verification Results (TVR)  | 5      | Binary   | Card may copy or reflect terminal's TVR |
| 9A    | Transaction Date                     | 3      | BCD      | YYMMDD (00–99, 01–12, 01–31) |
| 9C    | Transaction Type                     | 1      | Binary   | 0x00 purchase, 0x20 refund, etc. |
| 5F2A  | Transaction Currency Code            | 2      | Binary   | ISO-4217 numeric, big-endian |
| 9F1A  | Terminal Country Code                | 2      | Binary   | ISO-3166 numeric, big-endian |
| 9F02  | Amount, Authorised (Txn)             | 6      | BCD      | 12-digit fixed (e.g. $100.00 = 000000010000) |
| 9F03  | Amount, Other                        | 6      | BCD      | Often 000000000000 |
| 9F34  | Cardholder Verification Results (CVM)| 3      | Binary   | CVM outcome |
| 82    | Application Interchange Profile (AIP)| 2      | Binary   | Capabilities: SDA, DDA, CDA, etc. |
| 84    | Dedicated File (AID)                 | 5–16   | Binary   | Application identifier (e.g. A0000000031010) |
| 9F09  | Application Version Number           | 2      | Binary   | Must match terminal supported version |
| 9F41  | Transaction Sequence Counter (TSI)   | 4      | Binary   | Cumulative log of functions performed |
| 9F1C  | Terminal Identification              | 8      | ASCII    | Unique terminal ID |
| 9F16  | Merchant Identifier                  | 15     | ASCII    | Unique merchant ID |
| 9F01  | Acquirer Identifier                  | 6      | Binary   | Identifies acquiring institution or processor |

---

## 3. CDA / Dynamic Signature Data

| Tag   | Name                              | Length | Format   | Notes |
|-------|-----------------------------------|--------|----------|-------|
| 9F4B  | Signed Dynamic Application Data   | Var    | Binary   | RSA signature block (128 bytes for RSA-1024, 256 bytes for RSA-2048). Encodes PKCS#1 v1.5 padded digest. |

The `9F4B` block is constructed internally by the card as **Signed Data Format 3**:

```
6A ; Header
03 ; Format (CDA)
[ARQC] ; Application Cryptogram (9F26)
[UN] ; Unpredictable Number (9F37)
[ATC] ; Application Tx Counter (9F36)
[Amount] ; 9F02
[Currency] ; 5F2A
[Date] ; 9A
[TxnType] ; 9C
[TVR] ; 95
[CVM] ; 9F34
[TerminalID]; 9F1C
[MerchantID]; 9F16
[AcquirerID]; 9F01
[Hash] ; SHA-256 of above
BC ; Trailer
```

This structure is padded and signed with the ICC's RSA private key.

---

## 4. CDOL1 Schema

The **Card Risk Management Data Object List 1 (CDOL1)** tells the terminal which data elements must be provided when requesting a first Application Cryptogram.

### Example CDOL1 Layout

```
8C 36
9F02 06 ; Amount, Authorised
9F03 06 ; Amount, Other
9F1A 02 ; Terminal Country Code
95 05   ; Terminal Verification Results
5F2A 02 ; Transaction Currency Code
9A 03   ; Transaction Date
9C 01   ; Transaction Type
9F37 04 ; Unpredictable Number
9F1C 08 ; Terminal ID
9F16 0F ; Merchant ID
9F01 06 ; Acquirer Identifier
```

- `8C` = CDOL1 tag  
- `36` = Length of the data block (54 bytes)  
- Each entry = Tag + expected length  
- Terminal must supply exactly 54 bytes in this order when calling `GENERATE AC`.

---

## 5. Bounds and Ranges

- ATC (9F36): 0x0001–0xFFFF, must never reset except at personalization.
- Amounts (9F02, 9F03): 12-digit fixed BCD (000000000000–999999999999).
- Currency / Country Codes: ISO-4217 / ISO-3166 numeric ranges.
- Dates (9A): YY 00–99, MM 01–12, DD 01–31.
- Terminal ID (9F1C): 8 ASCII characters (uint64 in contract interfaces).
- Merchant ID (9F16): Up to 15 ASCII characters (uint120 in contract interfaces).
- Acquirer ID (9F01): 6-byte binary identifier for acquiring institution (uint48 in contract interfaces).
- Signature (9F4B): Length exactly matches modulus length.

---

## 6. Order of Inclusion in DE55

When the card returns ICC data (DE55 in ISO-8583), fields must be ordered by ascending tag. Example:

```
82 (AIP)
84 (AID)
95 (TVR)
9A (Txn Date)
9C (Txn Type)
9F01 (Acquirer ID)
9F02 (Amount)
9F03 (Other Amount)
9F09 (App Version)
9F10 (IAD)
9F16 (Merchant ID)
9F1A (Country Code)
9F1C (Terminal ID)
9F26 (Cryptogram)
9F27 (Cryptogram Info)
9F34 (CVM)
9F36 (ATC)
9F37 (UN)
9F41 (TSI)
9F4B (SDAD)
```

---

## 7. Security Requirements
- ARQC/SDAD must change each transaction (ATC increment + new UN).
- Signature (9F4B) must always match modulus length.
- Issuer keys must be RSA-2048 or greater in new deployments.
- Hashing: EMV v4.4 requires SHA-256 for new cards; SHA-1 only for backward compatibility.

---

## 8. Out of Scope
- Certificate Authority (CA) management.
- Personalization scripts.
- Offline data authentication (SDA/DDA) not covered here.
